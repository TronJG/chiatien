<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chia tiền bạn bè</title>
  <meta name="description"
    content="Web chia tiền giữa bạn bè – chạy trên GitHub Pages, lưu cục bộ bằng LocalStorage. Viết thuần HTML/CSS/JS." />
  <style>
    :root {
      --bg: #ffffff;
      --panel: #f7faf7;
      --soft: #d9e7db;
      --text: #1b1f1c;
      --muted: #5b6b5e;
      --accent: #31c36a;
      --accent-2: #22a455;
      --error: #e03131;
      --shadow: 0 6px 18px rgba(0, 0, 0, .06);
      --radius: 14px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px
    }

    .brand {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .logo {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, #e8f8ee, #f6fff9);
      border: 1px solid var(--soft);
      box-shadow: var(--shadow)
    }

    .logo svg {
      width: 20px;
      height: 20px;
      fill: var(--accent)
    }

    h1 {
      font-size: 18px;
      margin: 0
    }

    .hint {
      color: var(--muted);
      font-size: 13px
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr
      }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--soft);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px
    }

    .card h2 {
      font-size: 15px;
      margin: 0 0 6px
    }

    .card p.caption {
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 13px
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .input,
    select {
      appearance: none;
      border: 1px solid var(--soft);
      background: #fff;
      border-radius: 10px;
      padding: 9px 12px;
      font: inherit;
      color: var(--text);
      width: 100%
    }

    .input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(49, 195, 106, .15)
    }

    .btn {
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      padding: 9px 12px;
      font: inherit;
      cursor: pointer;
      transition: .15s;
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .btn.secondary {
      background: #fff;
      color: var(--accent);
      border-color: var(--accent)
    }

    .btn.danger {
      background: #fff;
      color: var(--error);
      border-color: var(--error)
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .btn:hover {
      filter: brightness(.98)
    }

    .friend-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fff;
      border: 1px solid var(--soft);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 13px
    }

    .chip .x {
      cursor: pointer;
      opacity: .6
    }

    .chip .x:hover {
      opacity: 1
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    @media (min-width: 500px) {
      .form-row {
        flex-direction: row
      }
    }

    .friend-select {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    .friend-select label {
      border: 1px dashed var(--soft);
      padding: 6px 8px;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px
    }

    .friend-select input {
      accent-color: var(--accent)
    }

    .items {
      display: grid;
      gap: 8px;
      margin-top: 8px
    }

    .item {
      border: 1px solid var(--soft);
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      font-size: 14px
    }

    .item-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      align-items: center
    }

    .item-name {
      font-weight: 600
    }

    .item-amount {
      color: var(--accent-2);
      font-weight: 600
    }

    .item-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    .summary {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px
    }

    .summary th,
    .summary td {
      border-bottom: 1px solid var(--soft);
      padding: 8px;
      text-align: left
    }

    .summary th.sortable {
      cursor: pointer;
      user-select: none
    }

    .summary tfoot td {
      font-weight: 700
    }

    .footer {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      font-size: 13px
    }

    .save-state {
      font-size: 12px;
      color: var(--muted)
    }

    .empty {
      border: 1px dashed var(--soft);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      color: var(--muted);
      font-size: 13px
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #effaf4;
      color: var(--accent-2);
      border: 1px solid var(--soft);
      font-size: 12px
    }

    .link {
      color: var(--accent-2);
      text-decoration: none;
      font-size: 14px
    }

    /* ===== Mobile-first refinements ===== */
    .btn {
      min-height: 44px
    }

    .input,
    select,
    .chip-input {
      min-height: 44px
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px
    }

    .friend-select label {
      padding: 10px 12px
    }

    .item-actions .btn {
      min-width: 110px
    }

    dialog .card {
      width: min(560px, 92vw)
    }

    @media (max-width:980px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    @media (max-width:720px) {
      .wrap {
        padding: 14px
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px
      }

      .logo {
        width: 34px;
        height: 34px
      }

      h1 {
        font-size: clamp(18px, 4.6vw, 20px)
      }

      .card {
        padding: 12px;
        border-radius: 14px
      }

      .toolbar {
        gap: 8px
      }

      .toolbar .btn,
      .toolbar .input {
        flex: 1
      }

      .form-row {
        grid-template-columns: 1fr
      }

      .item-top {
        flex-direction: column;
        align-items: flex-start
      }

      .item-amount {
        margin-top: 6px
      }

      .item-actions {
        flex-wrap: wrap
      }

      .item-actions .btn {
        flex: 1
      }

      .footer {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        padding-top: 10px;
        background: var(--panel);
        border-top: 1px solid var(--soft);
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius)
      }

      .summary th,
      .summary td {
        padding: 8px
      }
    }

    /* Ép mobile hiển thị 1 cột theo đúng thứ tự DOM: 1,2,3,4 */
    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }

      /* Ghi đè grid-column đang đặt inline ở mục (3) và (4) */
      .grid>.card {
        grid-column: auto !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm4.93 7.36-5.66 5.66a1 1 0 0 1-1.41 0L7.07 12.83a1 1 0 0 1 1.41-1.41L10 12.94l4.95-4.95a1 1 0 1 1 1.41 1.41Z" />
          </svg>
        </div>
        <div>
          <h1>Chia tiền bạn bè</h1>
          <div class="hint">Thuần HTML/CSS/JS • Lưu cục bộ (LocalStorage) • Chủ đạo trắng & xanh lá</div>
        </div>
      </div>
      <a class="link" href="#" id="howtoLink">Hướng dẫn</a>
    </header>

    <div class="grid">
      <!-- Cột trái: bạn bè + tạo mục -->
      <section class="card">
        <h2>1) Danh sách bạn bè</h2>
        <p class="caption">Thêm bạn một lần, sau đó chọn ai tham gia cho từng mục.</p>
        <div class="toolbar" style="margin-bottom:8px">
          <input id="friendName" class="input" placeholder="Tên bạn (ví dụ: An, Bình, Chi)" aria-label="Tên bạn" />
          <button id="addFriendBtn" class="btn" title="Thêm bạn" aria-label="Thêm bạn">+ Thêm</button>
          <button id="clearAllBtn" class="btn danger" title="Xoá toàn bộ dữ liệu" aria-label="Xoá tất cả">Xoá tất
            cả</button>
        </div>
        <div id="friends" class="friend-list" aria-live="polite"></div>
      </section>

      <section class="card">
        <h2>2) Mục chi tiêu</h2>
        <p class="caption">Mỗi mục có tên, số tiền và danh sách người tham gia. Tiền sẽ được chia đều cho những người
          được chọn.</p>
        <div class="form-row">
          <input id="itemName" class="input" placeholder="Tên mục (vd: Lẩu, Cà phê, Taxi)" aria-label="Tên mục" />
          <input id="itemAmount" class="input" type="number" inputmode="decimal" min="0" step="1000"
            placeholder="Số tiền (VND)" aria-label="Số tiền VND" />
        </div>
        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Ai tham gia mục này?</div>
          <div id="participantSelect" class="friend-select"></div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button id="addItemBtn" class="btn" aria-label="Thêm mục">Thêm mục</button>
          <button id="selectAllBtn" class="btn secondary" aria-label="Chọn tất cả người tham gia">Chọn tất cả</button>
          <button id="selectNoneBtn" class="btn secondary" aria-label="Bỏ chọn người tham gia">Bỏ chọn</button>
        </div>
      </section>

      <!-- Cột trái dưới: danh sách mục -->
      <section class="card" style="grid-column:1/2">
        <h2>3) Danh sách mục</h2>
        <div id="items" class="items"></div>
        <div id="itemsEmpty" class="empty" style="display:none">Chưa có mục nào. Hãy thêm mục ở khung bên phải.</div>
      </section>

      <!-- Cột phải dưới: tổng kết -->
      <section class="card" style="grid-column:2/3">
        <h2>4) Tổng kết & Xuất kết quả</h2>
        <table class="summary" id="summaryTable" aria-live="polite"></table>
        <div class="footer">
          <div class="toolbar">
            <button id="copyBtn" class="btn secondary" aria-label="Sao chép kết quả">Sao chép kết quả</button>
            <button id="csvBtn" class="btn secondary" aria-label="Tải file CSV">Tải CSV</button>
          </div>
          <div class="save-state" id="saveState" aria-live="polite">Đã lưu cục bộ.</div>
        </div>
      </section>
    </div>

    <p class="hint" style="margin-top:16px">Lưu ý: Chia đều theo từng mục dựa trên số người tham gia mục đó. Làm tròn
      hiển thị theo VND – nội bộ tính chính xác số thực.</p>
  </div>

  <!-- a11y: role + aria-labelledby -->
  <dialog id="howto" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
    <form method="dialog" style="margin:0">
      <div class="card" style="max-width:640px">
        <h2 id="howtoTitle">Hướng dẫn nhanh</h2>
        <ol style="margin:8px 0 12px; padding-left:18px">
          <li>Thêm <b>bạn bè</b> ở bước (1).</li>
          <li>Tại (2), nhập <b>Tên mục</b>, <b>Số tiền</b> và <b>chọn người tham gia</b> rồi nhấn <b>Thêm mục</b>.</li>
          <li>Ở (3) bạn có thể xoá/sửa từng mục.</li>
          <li>Xem <b>Tổng kết</b> ở (4). Nhấn <b>Sao chép</b> hoặc <b>Tải CSV</b> để gửi cho mọi người.</li>
        </ol>
        <div class="toolbar" style="justify-content:flex-end">
          <button class="btn secondary" aria-label="Đóng hướng dẫn">Đã hiểu</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    ; (() => {
      const $ = (sel, el = document) => el.querySelector(sel)
      const $$ = (sel, el = document) => [...el.querySelectorAll(sel)]
      const fmt = new Intl.NumberFormat('vi-VN')
      const storeKey = 'split_friends_v1'

      const state = {
        friends: [], // ["An","Bình",...]
        items: []    // [{id,name,amount,participants:[name,...]}]
      }

      // ===== NEW: sort state for summary =====
      let sortState = { by: 'name', dir: 'asc' } // 'name' | 'amount' ; 'asc' | 'desc'

      // Load from localStorage
      function load() {
        try {
          const raw = localStorage.getItem(storeKey)
          if (raw) {
            const data = JSON.parse(raw)
            if (Array.isArray(data.friends)) state.friends = data.friends
            if (Array.isArray(data.items)) state.items = data.items
          }
        } catch (e) { console.warn('Load failed', e) }
      }

      function save() {
        localStorage.setItem(storeKey, JSON.stringify(state))
        const el = $('#saveState')
        if (el) { el.textContent = 'Đã lưu cục bộ.'; el.style.opacity = 1; }
        clearTimeout(save._t)
        save._t = setTimeout(() => { if (el) { el.style.opacity = .6 } }, 1200)
      }

      // --- Friends UI ---
      function renderFriends() {
        const wrap = $('#friends')
        wrap.innerHTML = ''
        if (state.friends.length === 0) {
          wrap.innerHTML = '<span class="badge">Chưa có bạn nào</span>'
        } else {
          state.friends.forEach(name => {
            const chip = document.createElement('div')
            chip.className = 'chip'
            // a11y: x có role button + tabindex
            chip.innerHTML = `<span>👤 ${escapeHtml(name)}</span> <span class="x" role="button" tabindex="0" aria-label="Xoá ${escapeAttr(name)}" title="Xoá" data-name="${escapeHtml(name)}">✕</span>`
            wrap.appendChild(chip)
          })
        }
        // re-render participant selector & summary
        renderParticipantSelector()
        renderSummary()
      }

      function addFriend(name) {
        name = name.trim()
        if (!name) { toast('Vui lòng nhập tên bạn'); $('#friendName').focus(); return }
        if (state.friends.includes(name)) { toast('Tên đã tồn tại'); $('#friendName').focus(); return }
        state.friends.push(name)
        save(); renderFriends(); renderItems()
        $('#friendName').value = ''
        // ===== NEW: focus back to input after add =====
        $('#friendName').focus()
      }

      function removeFriend(name) {
        if (!confirm(`Xoá bạn "${name}"? Người này cũng sẽ bị gỡ khỏi các mục đã chọn.`)) return
        state.friends = state.friends.filter(n => n !== name)
        // Remove from participants in all items
        state.items.forEach(it => {
          it.participants = it.participants.filter(n => n !== name)
        })
        save(); renderFriends(); renderItems()
      }

      // --- Participant selector ---
      function renderParticipantSelector() {
        const box = $('#participantSelect')
        box.innerHTML = ''
        if (state.friends.length === 0) {
          box.innerHTML = '<span class="badge">Hãy thêm bạn ở bước (1)</span>'
          return
        }
        state.friends.forEach(name => {
          const id = 'p_' + hash(name)
          const label = document.createElement('label')
          label.innerHTML = `<input type="checkbox" id="${id}" value="${escapeHtml(name)}"> <span>${escapeHtml(name)}</span>`
          box.appendChild(label)
        })
      }

      function setAllParticipants(val) {
        $$('#participantSelect input[type="checkbox"]').forEach(cb => cb.checked = val)
      }

      // --- Items ---
      function addItem() {
        const name = $('#itemName').value.trim() || `Mục #${state.items.length + 1}`
        const amount = parseFloat($('#itemAmount').value)
        const participants = $$('#participantSelect input:checked').map(cb => cb.value)
        if (isNaN(amount) || amount <= 0) { toast('Nhập số tiền hợp lệ (>0)'); return }
        if (participants.length === 0) { toast('Chọn ít nhất 1 người tham gia'); return }
        const item = { id: uid(), name, amount, participants }
        state.items.push(item)
        save(); renderItems(); clearItemForm(); renderSummary()
      }

      function clearItemForm() {
        $('#itemName').value = ''
        $('#itemAmount').value = ''
        setAllParticipants(false)
      }

      function renderItems() {
        const list = $('#items')
        const empty = $('#itemsEmpty')
        list.innerHTML = ''
        if (state.items.length === 0) { empty.style.display = 'block'; return }
        empty.style.display = 'none'

        state.items.forEach(it => {
          const el = document.createElement('div')
          el.className = 'item'
          const per = it.participants.length ? it.amount / it.participants.length : 0
          el.innerHTML = `
          <div class="item-top">
            <div>
              <div class="item-name">${escapeHtml(it.name)}</div>
              <div class="muted">Tham gia: ${it.participants.map(escapeHtml).join(', ')}</div>
            </div>
            <div>
              <div class="item-amount">${fmt.format(it.amount)} đ</div>
              <div class="muted" style="text-align:right">~ ${fmt.format(per)} đ/người</div>
            </div>
          </div>
          <div class="item-actions" style="margin-top:10px">
            <button class="btn secondary" data-edit="${it.id}" aria-label="Sửa mục ${escapeAttr(it.name)}">Sửa</button>
            <button class="btn danger" data-del="${it.id}" aria-label="Xoá mục ${escapeAttr(it.name)}">Xoá</button>
          </div>
        `
          list.appendChild(el)
        })
      }

      function deleteItem(id) {
        state.items = state.items.filter(it => it.id !== id)
        save(); renderItems(); renderSummary()
      }

      function editItem(id) {
        const it = state.items.find(x => x.id === id)
        if (!it) return
        // Inline editor dialog (a11y: role, aria)
        const dlg = document.createElement('dialog')
        dlg.setAttribute('role', 'dialog')
        dlg.setAttribute('aria-modal', 'true')
        dlg.innerHTML = `
        <form method="dialog" style="margin:0">
          <div class="card" style="max-width:560px">
            <h2 id="editTitle">Chỉnh sửa mục</h2>
            <div class="form-row">
              <input class="input" id="eName" value="${escapeAttr(it.name)}" aria-labelledby="editTitle" />
              <input class="input" id="eAmount" type="number" min="0" step="1000" value="${it.amount}" aria-label="Số tiền VND"/>
            </div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:6px">Chọn người tham gia</div>
              <div id="eParticipants" class="friend-select"></div>
            </div>
            <div class="toolbar" style="margin-top:12px;justify-content:flex-end">
              <button class="btn secondary">Huỷ</button>
              <button class="btn" value="ok">Lưu</button>
            </div>
          </div>
        </form>
      `
        document.body.appendChild(dlg)
        const box = $('#eParticipants', dlg)
        state.friends.forEach(name => {
          const idc = 'e_' + hash(name)
          const checked = it.participants.includes(name) ? 'checked' : ''
          const label = document.createElement('label')
          label.innerHTML = `<input type="checkbox" id="${idc}" value="${escapeHtml(name)}" ${checked}> <span>${escapeHtml(name)}</span>`
          box.appendChild(label)
        })
        dlg.showModal()
        dlg.addEventListener('close', () => {
          if (dlg.returnValue === 'ok') {
            const newName = $('#eName', dlg).value.trim() || it.name
            const newAmount = parseFloat($('#eAmount', dlg).value)
            const newParticipants = $$('#eParticipants input:checked', dlg).map(cb => cb.value)
            if (isNaN(newAmount) || newAmount <= 0 || newParticipants.length === 0) {
              toast('Vui lòng nhập dữ liệu hợp lệ');
            } else {
              it.name = newName
              it.amount = newAmount
              it.participants = newParticipants
              save(); renderItems(); renderSummary()
            }
          }
          dlg.remove()
        })
      }

      // --- Summary ---
      function computeSummary() {
        const totals = Object.fromEntries(state.friends.map(n => [n, 0]))
        let grand = 0
        for (const it of state.items) {
          if (it.participants.length === 0) continue
          const share = it.amount / it.participants.length
          grand += it.amount
          for (const name of it.participants) {
            if (!(name in totals)) totals[name] = 0
            totals[name] += share
          }
        }
        return { totals, grand }
      }

      function renderSummary() {
        const tbl = $('#summaryTable')
        const { totals, grand } = computeSummary()
        const rows = Object.entries(totals) // [ [name, value], ... ]

        if (state.friends.length === 0) {
          tbl.innerHTML = '<tr><td class="empty">Hãy thêm bạn bè để xem tổng kết</td></tr>'
          return
        }
        if (rows.length === 0) {
          tbl.innerHTML = '<tr><td class="empty">Chưa có dữ liệu tổng kết</td></tr>'
          return
        }

        // ===== NEW: sorting rows by state =====
        rows.sort((a, b) => {
          if (sortState.by === 'name') {
            return sortState.dir === 'asc' ? a[0].localeCompare(b[0]) : b[0].localeCompare(a[0])
          } else {
            // amount
            return sortState.dir === 'asc' ? a[1] - b[1] : b[1] - a[1]
          }
        })

        const body = rows.map(([name, val]) => `<tr><td>${escapeHtml(name)}</td><td>${fmt.format(val)} đ</td></tr>`).join('')

        const nameArrow = sortState.by === 'name' ? (sortState.dir === 'asc' ? ' ▲' : ' ▼') : ''
        const amountArrow = sortState.by === 'amount' ? (sortState.dir === 'asc' ? ' ▲' : ' ▼') : ''

        const nameAria = sortState.by === 'name' ? (sortState.dir === 'asc' ? 'ascending' : 'descending') : 'none'
        const amountAria = sortState.by === 'amount' ? (sortState.dir === 'asc' ? 'ascending' : 'descending') : 'none'

        tbl.innerHTML = `
        <thead>
          <tr>
            <th class="sortable" data-sort="name" aria-sort="${nameAria}" scope="col">Người${nameArrow}</th>
            <th class="sortable" data-sort="amount" aria-sort="${amountAria}" scope="col">Số tiền phải trả${amountArrow}</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
        <tfoot><tr><td>Tổng các mục</td><td>${fmt.format(grand)} đ</td></tr></tfoot>
      `
      }

      function toggleSort(by) {
        if (sortState.by === by) {
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc'
        } else {
          sortState.by = by
          sortState.dir = 'asc'
        }
        renderSummary()
      }

      function copySummary() {
        const { totals, grand } = computeSummary()
        const lines = ['Tổng kết chia tiền:', ...Object.entries(totals).map(([n, v]) => `- ${n}: ${fmt.format(v)} đ`), `Tổng các mục: ${fmt.format(grand)} đ`]
        navigator.clipboard.writeText(lines.join('\n')).then(() => toast('Đã sao chép')), () => toast('Không thể sao chép')
      }

      function pad(n) { return String(n).padStart(2, '0') }

      function downloadCSV() {
        const { totals, grand } = computeSummary()
        const rows = [['Tên', 'Số tiền (VND)'], ...Object.entries(totals).map(([n, v]) => [n, Math.round(v)])]
        rows.push(['Tổng', Math.round(grand)])
        const csv = rows.map(r => r.map(x => '"' + String(x).replaceAll('"', '""') + '"').join(',')).join('\n')
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8' })
        const a = document.createElement('a')
        a.href = URL.createObjectURL(blob)
        // ===== NEW: filename with date-time =====
        const d = new Date()
        const fname = `tong-ket-chia-tien_${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}.csv`
        a.download = fname
        a.click()
        URL.revokeObjectURL(a.href)
      }

      // --- Utils ---
      function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8) }
      function hash(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = (h << 5) - h + s.charCodeAt(i); h |= 0 } return Math.abs(h) }
      function escapeHtml(s) { return s.replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', '\'': '&#39;' }[c])) }
      function escapeAttr(s) { return escapeHtml(s).replace(/\n/g, ' ') }

      function toast(msg) {
        const t = document.createElement('div')
        t.textContent = msg
        Object.assign(t.style, { position: 'fixed', left: '50%', bottom: '22px', transform: 'translateX(-50%)', background: '#0b0', color: '#fff', padding: '10px 14px', borderRadius: '12px', boxShadow: 'var(--shadow)', fontSize: '14px', zIndex: 9999, background: 'linear-gradient(90deg, var(--accent), var(--accent-2))' })
        document.body.appendChild(t)
        setTimeout(() => { t.style.transition = 'opacity .4s'; t.style.opacity = '0'; setTimeout(() => t.remove(), 400) }, 1100)
      }

      // --- Events ---
      $('#addFriendBtn').addEventListener('click', () => addFriend($('#friendName').value))
      $('#friendName').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addFriend($('#friendName').value) } })
      $('#clearAllBtn').addEventListener('click', () => {
        if (confirm('Xoá toàn bộ bạn bè, mục và tổng kết?')) {
          state.friends = []; state.items = []; save(); renderFriends(); renderItems(); renderSummary();
          $('#friendName').focus()
        }
      })

      $('#addItemBtn').addEventListener('click', addItem)
      $('#selectAllBtn').addEventListener('click', () => setAllParticipants(true))
      $('#selectNoneBtn').addEventListener('click', () => setAllParticipants(false))

      $('#items').addEventListener('click', (e) => {
        const del = e.target.closest('[data-del]')
        const edit = e.target.closest('[data-edit]')
        if (del) { deleteItem(del.getAttribute('data-del')) }
        if (edit) { editItem(edit.getAttribute('data-edit')) }
      })

      // a11y: remove friend via click OR Enter/Space
      $('#friends').addEventListener('click', (e) => {
        const x = e.target.closest('.x')
        if (x) { removeFriend(x.getAttribute('data-name')) }
      })
      $('#friends').addEventListener('keydown', (e) => {
        const x = e.target.closest('.x')
        if (x && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault()
          removeFriend(x.getAttribute('data-name'))
        }
      })

      $('#copyBtn').addEventListener('click', copySummary)
      $('#csvBtn').addEventListener('click', downloadCSV)

      $('#howtoLink').addEventListener('click', (e) => { e.preventDefault(); $('#howto').showModal() })

      // ===== NEW: header click to sort =====
      $('#summaryTable').addEventListener('click', (e) => {
        const th = e.target.closest('.sortable')
        if (!th) return
        const by = th.getAttribute('data-sort')
        toggleSort(by)
      })

      // Initial
      load();
      renderFriends();
      renderItems();
      renderSummary();
      // Focus ngay ô nhập bạn để thao tác nhanh
      $('#friendName').focus()

    })()
  </script>
</body>

</html>