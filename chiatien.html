<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chia ti·ªÅn b·∫°n b√®</title>
  <meta name="description" content="Web chia ti·ªÅn gi·ªØa b·∫°n b√® ‚Äì ch·∫°y tr√™n GitHub Pages, l∆∞u c·ª•c b·ªô b·∫±ng LocalStorage. Vi·∫øt thu·∫ßn HTML/CSS/JS." />
  <style>
    :root { --bg:#ffffff; --panel:#f7faf7; --soft:#d9e7db; --text:#1b1f1c; --muted:#5b6b5e; --accent:#31c36a; --accent-2:#22a455; --error:#e03131; --shadow:0 6px 18px rgba(0,0,0,.06); --radius:14px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .logo{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#e8f8ee,#f6fff9);border:1px solid var(--soft);box-shadow:var(--shadow)}
    .logo svg{width:20px;height:20px;fill:var(--accent)}
    h1{font-size:18px;margin:0}
    .hint{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:768px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--panel);border:1px solid var(--soft);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2{font-size:15px;margin:0 0 6px}
    .card p.caption{margin:0 0 10px;color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .input, select{appearance:none;border:1px solid var(--soft);background:#fff;border-radius:10px;padding:9px 12px;font:inherit;color:var(--text);width:100%}
    .input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(49,195,106,.15)}
    .btn{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:9px 12px;font:inherit;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:6px}
    .btn.secondary{background:#fff;color:var(--accent);border-color:var(--accent)}
    .btn.danger{background:#fff;color:var(--error);border-color:var(--error)}
    .btn:disabled{opacity:.5;cursor:not-allowed} .btn:hover{filter:brightness(.98)}
    .friend-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--soft);border-radius:999px;padding:5px 9px;font-size:13px}
    .chip .x{cursor:pointer;opacity:.6}.chip .x:hover{opacity:1}
    .form-row{display:flex;flex-direction:column;gap:8px}
    @media (min-width:500px){ .form-row{flex-direction:row} }
    .friend-select{display:flex;flex-wrap:wrap;gap:6px}
    .friend-select label{border:1px dashed var(--soft);padding:6px 8px;border-radius:8px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px;font-size:13px}
    .friend-select input{accent-color:var(--accent)}
    .items{display:grid;gap:8px;margin-top:8px}
    .item{border:1px solid var(--soft);background:#fff;border-radius:10px;padding:10px;font-size:14px}
    .item-top{display:flex;flex-wrap:wrap;justify-content:space-between;gap:6px;align-items:center}
    .item-name{font-weight:600} .item-amount{color:var(--accent-2);font-weight:600}
    .item-actions{display:flex;gap:6px;margin-top:6px}
    .muted{color:var(--muted);font-size:13px}
    .summary{width:100%;border-collapse:collapse;font-size:14px}
    .summary th,.summary td{border-bottom:1px solid var(--soft);padding:8px;text-align:left}
    .summary th.sortable{cursor:pointer;user-select:none}
    .summary tfoot td{font-weight:700}
    .footer{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;font-size:13px}
    .save-state{font-size:12px;color:var(--muted)}
    .empty{border:1px dashed var(--soft);border-radius:10px;padding:14px;text-align:center;color:var(--muted);font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#effaf4;color:var(--accent-2);border:1px solid var(--soft);font-size:12px}
    .link{color:var(--accent-2);text-decoration:none;font-size:14px}
    .btn{min-height:44px} .input,select,.chip-input{min-height:44px} input[type="checkbox"]{width:18px;height:18px}
    .friend-select label{padding:10px 12px} .item-actions .btn{min-width:110px}
    dialog .card{width:min(560px,92vw)}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .grid>.card{grid-column:auto!important} }
    @media (max-width:720px){
      .wrap{padding:14px} header{flex-direction:column;align-items:flex-start;gap:6px}
      .logo{width:34px;height:34px} h1{font-size:clamp(18px,4.6vw,20px)}
      .card{padding:12px;border-radius:14px} .toolbar{gap:8px}
      .toolbar .btn, .toolbar .input{flex:1} .form-row{grid-template-columns:1fr}
      .item-top{flex-direction:column;align-items:flex-start} .item-amount{margin-top:6px}
      .item-actions{flex-wrap:wrap} .item-actions .btn{flex:1}
      .footer{position:sticky;bottom:0;left:0;right:0;padding-top:10px;background:var(--panel);border-top:1px solid var(--soft);border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
      .summary th,.summary td{padding:8px}
    }
    /* Banner view-only */
    .banner{display:none;margin:-6px 0 8px;padding:10px 12px;background:#e8fff1;border:1px solid #c9edd6;border-radius:12px}
    .banner strong{color:#127a3a}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm4.93 7.36-5.66 5.66a1 1 0 0 1-1.41 0L7.07 12.83a1 1 0 0 1 1.41-1.41L10 12.94l4.95-4.95a1 1 0 1 1 1.41 1.41Z"/></svg>
        </div>
        <div>
          <h1>Chia ti·ªÅn b·∫°n b√®</h1>
          <div class="hint">Thu·∫ßn HTML/CSS/JS ‚Ä¢ L∆∞u c·ª•c b·ªô (LocalStorage) ‚Ä¢ Ch·ªß ƒë·∫°o tr·∫Øng & xanh l√°</div>
        </div>
      </div>
      <a class="link" href="#" id="howtoLink">H∆∞·ªõng d·∫´n</a>
    </header>

    <!-- Banner ch·ªâ xem -->
    <div id="viewBanner" class="banner">
      <strong>ƒêang ·ªü ch·∫ø ƒë·ªô CH·ªà XEM.</strong>
      <div class="toolbar" style="margin-top:6px">
        <button id="shareCopyBtn2" class="btn secondary">Copy l·∫°i li√™n k·∫øt n√†y</button>
        <button id="adoptBtn" class="btn">L∆∞u b·∫£n n√†y v√†o tr√¨nh duy·ªát ƒë·ªÉ ch·ªânh s·ª≠a</button>
      </div>
      <div class="muted" style="margin-top:4px">M·ªü t·ª´ li√™n k·∫øt #v=‚Ä¶ ‚Ä¢ B·∫°n ch·ªâ c√≥ th·ªÉ xem & t·∫°o QR, kh√¥ng th·ªÉ s·ª≠a.</div>
    </div>

    <div class="grid">
      <!-- (1) B·∫°n b√® -->
      <section class="card">
        <h2>1) Danh s√°ch b·∫°n b√®</h2>
        <p class="caption">Th√™m b·∫°n m·ªôt l·∫ßn, sau ƒë√≥ ch·ªçn ai tham gia cho t·ª´ng m·ª•c.</p>
        <div class="toolbar" style="margin-bottom:8px">
          <input id="friendName" class="input" placeholder="T√™n b·∫°n (v√≠ d·ª•: An, B√¨nh, Chi)" aria-label="T√™n b·∫°n" />
          <button id="addFriendBtn" class="btn" title="Th√™m b·∫°n" aria-label="Th√™m b·∫°n">+ Th√™m</button>
          <button id="clearAllBtn" class="btn danger" title="Xo√° to√†n b·ªô d·ªØ li·ªáu" aria-label="Xo√° t·∫•t c·∫£">Xo√° t·∫•t c·∫£</button>
        </div>
        <div id="friends" class="friend-list" aria-live="polite"></div>
      </section>

      <!-- (2) T·∫°o m·ª•c -->
      <section class="card">
        <h2>2) M·ª•c chi ti√™u</h2>
        <p class="caption">M·ªói m·ª•c c√≥ t√™n, s·ªë ti·ªÅn v√† danh s√°ch ng∆∞·ªùi tham gia. Ti·ªÅn s·∫Ω ƒë∆∞·ª£c chia ƒë·ªÅu cho nh·ªØng ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn.</p>
        <div class="form-row">
          <input id="itemName" class="input" placeholder="T√™n m·ª•c (vd: L·∫©u, C√† ph√™, Taxi)" aria-label="T√™n m·ª•c" />
          <input id="itemAmount" class="input" type="number" inputmode="decimal" min="0" step="1000" placeholder="S·ªë ti·ªÅn (VND)" aria-label="S·ªë ti·ªÅn VND" />
        </div>
        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Ai tham gia m·ª•c n√†y?</div>
          <div id="participantSelect" class="friend-select"></div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button id="addItemBtn" class="btn" aria-label="Th√™m m·ª•c">Th√™m m·ª•c</button>
          <button id="selectAllBtn" class="btn secondary" aria-label="Ch·ªçn t·∫•t c·∫£ ng∆∞·ªùi tham gia">Ch·ªçn t·∫•t c·∫£</button>
          <button id="selectNoneBtn" class="btn secondary" aria-label="B·ªè ch·ªçn ng∆∞·ªùi tham gia">B·ªè ch·ªçn</button>
        </div>
      </section>

      <!-- (3) Danh s√°ch m·ª•c -->
      <section class="card" style="grid-column:1/2">
        <h2>3) Danh s√°ch m·ª•c</h2>
        <div id="items" class="items"></div>
        <div id="itemsEmpty" class="empty" style="display:none">Ch∆∞a c√≥ m·ª•c n√†o. H√£y th√™m m·ª•c ·ªü khung b√™n ph·∫£i.</div>
      </section>

      <!-- (4) T·ªïng k·∫øt -->
      <section class="card" style="grid-column:2/3">
        <h2>4) T·ªïng k·∫øt & Xu·∫•t k·∫øt qu·∫£</h2>
        <table class="summary" id="summaryTable" aria-live="polite"></table>
        <div class="footer">
          <div class="toolbar">
            <button id="shareBtn" class="btn">T·∫°o link xem (copy)</button>
            <button id="copyBtn" class="btn secondary" aria-label="Sao ch√©p k·∫øt qu·∫£">Sao ch√©p k·∫øt qu·∫£</button>
            <button id="csvBtn" class="btn secondary" aria-label="T·∫£i file CSV">T·∫£i CSV</button>
          </div>
          <div class="save-state" id="saveState" aria-live="polite">ƒê√£ l∆∞u c·ª•c b·ªô.</div>
        </div>
      </section>

      <!-- (5) Th√¥ng tin nh·∫≠n ti·ªÅn & VietQR -->
      <section class="card" style="grid-column:1/3">
        <h2>5) Th√¥ng tin nh·∫≠n ti·ªÅn & VietQR</h2>
        <p class="caption">Ch·ªçn ng√¢n h√†ng (l·∫•y t·ª´ API VietQR), nh·∫≠p STK & t√™n TK. Sau ƒë√≥ b·∫•m QR ·ªü b·∫£ng T·ªïng k·∫øt ƒë·ªÉ t·∫°o m√£ VietQR ƒë√∫ng s·ªë ti·ªÅn.</p>
        <div class="form-row">
          <select id="bankSelect" aria-label="Ng√¢n h√†ng th·ª• h∆∞·ªüng">
            <option value="">‚Äî Ch·ªçn ng√¢n h√†ng ‚Äî</option>
          </select>
          <input id="accNo" class="input" placeholder="S·ªë t√†i kho·∫£n (ch·ªâ s·ªë)" aria-label="S·ªë t√†i kho·∫£n" />
        </div>
        <div class="form-row" style="margin-top:8px">
          <input id="accName" class="input" placeholder="T√™n t√†i kho·∫£n (kh√¥ng d·∫•u, IN HOA ‚Äì tu·ª≥ ch·ªçn)" aria-label="T√™n t√†i kho·∫£n" />
          <input id="addInfo" class="input" placeholder="N·ªôi dung chuy·ªÉn (<= 50 k√Ω t·ª±, kh√¥ng k√Ω t·ª± ƒë·∫∑c bi·ªát)" aria-label="N·ªôi dung chuy·ªÉn" />
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button id="testQR" class="btn secondary">Xem th·ª≠ QR 10.000ƒë</button>
          <span class="muted" id="bankStat">ƒêang t·∫£i ng√¢n h√†ng‚Ä¶</span>
        </div>
      </section>
    </div>

    <p class="hint" style="margin-top:16px">L∆∞u √Ω: Chia ƒë·ªÅu theo t·ª´ng m·ª•c d·ª±a tr√™n s·ªë ng∆∞·ªùi tham gia m·ª•c ƒë√≥. L√†m tr√≤n hi·ªÉn th·ªã theo VND ‚Äì n·ªôi b·ªô t√≠nh ch√≠nh x√°c s·ªë th·ª±c.</p>
  </div>

  <!-- H∆∞·ªõng d·∫´n -->
  <dialog id="howto" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
    <form method="dialog" style="margin:0">
      <div class="card" style="max-width:640px">
        <h2 id="howtoTitle">H∆∞·ªõng d·∫´n nhanh</h2>
        <ol style="margin:8px 0 12px; padding-left:18px">
          <li>Th√™m <b>b·∫°n b√®</b> ·ªü b∆∞·ªõc (1).</li>
          <li>·ªû (2) nh·∫≠p <b>T√™n m·ª•c/S·ªë ti·ªÅn</b> & <b>ch·ªçn ng∆∞·ªùi tham gia</b> ‚Üí <b>Th√™m m·ª•c</b>.</li>
          <li>·ªû (4) b·∫•m <b>QR</b> ƒë·ªÉ t·∫°o m√£, <b>ƒê√£ tr·∫£</b> ƒë·ªÉ ƒë√°nh d·∫•u, <b>Xo√° n·ª£</b> ƒë·ªÉ ƒë∆∞a v·ªÅ 0ƒë.</li>
          <li>Khai b√°o ph·∫ßn (5) ƒë·ªÉ QR ho·∫°t ƒë·ªông (Ng√¢n h√†ng, STK, n·ªôi dung).</li>
          <li>D√πng n√∫t <b>T·∫°o link xem</b> ƒë·ªÉ g·ª≠i cho b·∫°n b√®.</li>
        </ol>
        <div class="toolbar" style="justify-content:flex-end">
          <button class="btn secondary" aria-label="ƒê√≥ng h∆∞·ªõng d·∫´n">ƒê√£ hi·ªÉu</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Modal QR -->
  <dialog id="qrDialog" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <form method="dialog" style="margin:0">
      <div class="card" style="max-width:560px">
        <h2 id="qrTitle">QR thanh to√°n</h2>
        <div id="qrInfo" class="muted" style="margin-bottom:8px"></div>
        <div id="qrWrap" style="display:grid;place-items:center;padding:8px;border:1px dashed var(--soft);border-radius:12px;background:#fff"></div>
        <div class="toolbar" style="margin-top:12px;justify-content:flex-end">
          <button class="btn secondary">ƒê√≥ng</button>
          <a id="qrOpenLink" class="btn" target="_blank" rel="noopener">M·ªü ·∫£nh QR</a>
        </div>
      </div>
    </form>
  </dialog>

  <script>
  ;(()=>{
    const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>[...e.querySelectorAll(s)];
    const fmt=new Intl.NumberFormat('vi-VN'); const storeKey='split_friends_v1';

    // ====== STATE ======
    const state={ friends:[], items:[], paid:{}, waived:{},
      bank:{ bin:'', code:'', shortName:'', name:'', accountNo:'', accountName:'', addInfo:'' },
      banksCache:[] };

    let sortState={by:'name',dir:'asc'}; // for summary
    let viewOnly=false;                  // b·∫≠t khi m·ªü b·∫±ng link #v=
    let fromShared=false;                // ƒëang hi·ªÉn th·ªã snapshot t·ª´ link

    // ====== LOAD/SAVE ======
    function load(){
      try{ const raw=localStorage.getItem(storeKey);
        if(raw){ const data=JSON.parse(raw);
          state.friends = Array.isArray(data.friends)?data.friends:[];
          state.items   = Array.isArray(data.items)?data.items:[];
          state.paid    = data.paid||{};
          state.waived  = data.waived||{};
          state.bank    = Object.assign(state.bank, data.bank||{});
        }
      }catch(e){ console.warn('Load failed',e); }
    }
    function save(){
      const el=$('#saveState');
      if(viewOnly){
        if(el){ el.textContent='B·∫£n chia s·∫ª (ch·ªâ xem) ‚Äì kh√¥ng l∆∞u.'; el.style.opacity=1; }
        return; // kh√¥ng ghi LocalStorage khi ch·ªâ xem
      }
      localStorage.setItem(storeKey, JSON.stringify(state));
      if(el){ el.textContent='ƒê√£ l∆∞u c·ª•c b·ªô.'; el.style.opacity=1; }
      clearTimeout(save._t); save._t=setTimeout(()=>{ if(el){ el.style.opacity=.6 } },1200);
    }

    // ====== FRIENDS UI ======
    function renderFriends(){
      const wrap=$('#friends'); wrap.innerHTML='';
      if(state.friends.length===0){ wrap.innerHTML='<span class="badge">Ch∆∞a c√≥ b·∫°n n√†o</span>'; }
      else{
        state.friends.forEach(name=>{
          const chip=document.createElement('div'); chip.className='chip';
          const xBtn = viewOnly ? '' : ` <span class="x" role="button" tabindex="0" aria-label="Xo√° ${escAttr(name)}" title="Xo√°" data-name="${esc(name)}">‚úï</span>`;
          chip.innerHTML=`<span>üë§ ${esc(name)}</span>${xBtn}`;
          wrap.appendChild(chip);
        });
      }
      renderParticipantSelector(); renderSummary();
    }
    function addFriend(name){
      if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; }
      name=name.trim(); if(!name){ toast('Vui l√≤ng nh·∫≠p t√™n b·∫°n'); $('#friendName').focus(); return; }
      if(state.friends.includes(name)){ toast('T√™n ƒë√£ t·ªìn t·∫°i'); $('#friendName').focus(); return; }
      state.friends.push(name); save(); renderFriends(); renderItems(); $('#friendName').value=''; $('#friendName').focus();
    }
    function removeFriend(name){
      if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; }
      if(!confirm(`Xo√° b·∫°n "${name}"? Ng∆∞·ªùi n√†y c≈©ng s·∫Ω b·ªã g·ª° kh·ªèi c√°c m·ª•c ƒë√£ ch·ªçn.`)) return;
      state.friends=state.friends.filter(n=>n!==name);
      state.items.forEach(it=>{ it.participants=it.participants.filter(n=>n!==name); });
      delete state.paid[name]; delete state.waived[name];
      save(); renderFriends(); renderItems(); renderSummary();
    }

    // ====== PARTICIPANTS ======
    function renderParticipantSelector(){
      const box=$('#participantSelect'); box.innerHTML='';
      if(state.friends.length===0){ box.innerHTML='<span class="badge">H√£y th√™m b·∫°n ·ªü b∆∞·ªõc (1)</span>'; return; }
      state.friends.forEach(name=>{
        const id='p_'+hash(name); const label=document.createElement('label');
        label.innerHTML=`<input type="checkbox" id="${id}" value="${esc(name)}" ${viewOnly?'disabled':''}> <span>${esc(name)}</span>`;
        box.appendChild(label);
      });
    }
    function setAllParticipants(v){ if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; } $$('#participantSelect input[type="checkbox"]').forEach(cb=>cb.checked=v); }

    // ====== ITEMS ======
    function addItem(){
      if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; }
      const name=$('#itemName').value.trim()||`M·ª•c #${state.items.length+1}`;
      const amount=parseFloat($('#itemAmount').value);
      const participants=$$('#participantSelect input:checked').map(cb=>cb.value);
      if(isNaN(amount)||amount<=0){ toast('Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá (>0)'); return; }
      if(participants.length===0){ toast('Ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi tham gia'); return; }
      state.items.push({id:uid(), name, amount, participants});
      save(); renderItems(); clearItemForm(); renderSummary();
    }
    function clearItemForm(){ $('#itemName').value=''; $('#itemAmount').value=''; setAllParticipants(false); }
    function renderItems(){
      const list=$('#items'), empty=$('#itemsEmpty'); list.innerHTML='';
      if(state.items.length===0){ empty.style.display='block'; return; } empty.style.display='none';
      state.items.forEach(it=>{
        const el=document.createElement('div'); el.className='item';
        const per=it.participants.length? it.amount/it.participants.length:0;
        const actions = viewOnly ? '' : `
          <div class="item-actions" style="margin-top:10px">
            <button class="btn secondary" data-edit="${it.id}" aria-label="S·ª≠a m·ª•c ${escAttr(it.name)}">S·ª≠a</button>
            <button class="btn danger" data-del="${it.id}" aria-label="Xo√° m·ª•c ${escAttr(it.name)}">Xo√°</button>
          </div>`;
        el.innerHTML=`
          <div class="item-top">
            <div>
              <div class="item-name">${esc(it.name)}</div>
              <div class="muted">Tham gia: ${it.participants.map(esc).join(', ')}</div>
            </div>
            <div>
              <div class="item-amount">${fmt.format(it.amount)} ƒë</div>
              <div class="muted" style="text-align:right">~ ${fmt.format(per)} ƒë/ng∆∞·ªùi</div>
            </div>
          </div>
          ${actions}`;
        list.appendChild(el);
      });
    }
    function deleteItem(id){ if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; } state.items=state.items.filter(it=>it.id!==id); save(); renderItems(); renderSummary(); }
    function editItem(id){
      if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; }
      const it=state.items.find(x=>x.id===id); if(!it) return;
      const dlg=document.createElement('dialog'); dlg.setAttribute('role','dialog'); dlg.setAttribute('aria-modal','true');
      dlg.innerHTML=`<form method="dialog" style="margin:0"><div class="card" style="max-width:560px">
        <h2 id="editTitle">Ch·ªânh s·ª≠a m·ª•c</h2>
        <div class="form-row">
          <input class="input" id="eName" value="${escAttr(it.name)}" aria-labelledby="editTitle"/>
          <input class="input" id="eAmount" type="number" min="0" step="1000" value="${it.amount}" aria-label="S·ªë ti·ªÅn VND"/>
        </div>
        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Ch·ªçn ng∆∞·ªùi tham gia</div>
          <div id="eParticipants" class="friend-select"></div>
        </div>
        <div class="toolbar" style="margin-top:12px;justify-content:flex-end">
          <button class="btn secondary">Hu·ª∑</button>
          <button class="btn" value="ok">L∆∞u</button>
        </div>
      </div></form>`;
      document.body.appendChild(dlg);
      const box=$('#eParticipants',dlg);
      state.friends.forEach(name=>{
        const idc='e_'+hash(name); const checked=it.participants.includes(name)?'checked':'';
        const label=document.createElement('label');
        label.innerHTML=`<input type="checkbox" id="${idc}" value="${esc(name)}" ${checked}> <span>${esc(name)}</span>`;
        box.appendChild(label);
      });
      dlg.showModal();
      dlg.addEventListener('close', ()=>{
        if(dlg.returnValue==='ok'){
          const newName=$('#eName',dlg).value.trim()||it.name;
          const newAmount=parseFloat($('#eAmount',dlg).value);
          const newParticipants=$$('#eParticipants input:checked',dlg).map(cb=>cb.value);
          if(isNaN(newAmount)||newAmount<=0||newParticipants.length===0) toast('Vui l√≤ng nh·∫≠p d·ªØ li·ªáu h·ª£p l·ªá');
          else{ it.name=newName; it.amount=newAmount; it.participants=newParticipants; save(); renderItems(); renderSummary(); }
        }
        dlg.remove();
      });
    }

    // ====== SUMMARY ======
    function computeSummary(){
      const totals=Object.fromEntries(state.friends.map(n=>[n,0])); let grand=0;
      for(const it of state.items){
        if(it.participants.length===0) continue;
        const share=it.amount/it.participants.length; grand+=it.amount;
        for(const name of it.participants){ if(!(name in totals)) totals[name]=0; totals[name]+=share; }
      }
      return {totals, grand};
    }
    function getEffectiveAmount(name, base){
      if(state.waived[name]) return 0;
      if(state.paid[name])  return 0;
      return base;
    }
    function renderSummary(){
      const tbl=$('#summaryTable'); const {totals,grand}=computeSummary();
      const rows=Object.entries(totals);
      if(state.friends.length===0){ tbl.innerHTML='<tr><td class="empty">H√£y th√™m b·∫°n b√® ƒë·ªÉ xem t·ªïng k·∫øt</td></tr>'; return; }
      if(rows.length===0){ tbl.innerHTML='<tr><td class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu t·ªïng k·∫øt</td></tr>'; return; }

      rows.sort((a,b)=>{
        if(sortState.by==='name'){ return sortState.dir==='asc' ? a[0].localeCompare(b[0]) : b[0].localeCompare(a[0]); }
        const av=getEffectiveAmount(a[0],a[1]), bv=getEffectiveAmount(b[0],b[1]);
        return sortState.dir==='asc' ? av-bv : bv-av;
      });

      const body=rows.map(([name,base])=>{
        const val=getEffectiveAmount(name,base);
        const badges=[
          state.paid[name]  ? '<span class="badge">ƒê√£ tr·∫£</span>' : '',
          state.waived[name]? '<span class="badge">ƒê√£ xo√° n·ª£</span>' : ''
        ].filter(Boolean).join(' ');
        const sub = (state.paid[name]||state.waived[name]) ? `<div class="muted">G·ªëc: ${fmt.format(base)} ƒë</div>` : '';
        const actionBtns = viewOnly
          ? `<button class="btn secondary" data-qr="${escAttr(name)}">QR</button>`
          : `<button class="btn secondary" data-qr="${escAttr(name)}">QR</button>
             <button class="btn" data-paid="${escAttr(name)}">ƒê√£ tr·∫£</button>
             <button class="btn danger" data-waive="${escAttr(name)}">Xo√° n·ª£</button>`;
        const undoBtn = (!viewOnly && (state.paid[name]||state.waived[name])) ? `<button class="btn secondary" data-undo="${escAttr(name)}">Ho√†n t√°c</button>` : '';
        return `<tr>
          <td>${esc(name)} ${badges?`&nbsp;${badges}`:''}</td>
          <td>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <strong>${fmt.format(val)} ƒë</strong>${sub}
              ${actionBtns} ${undoBtn}
            </div>
          </td>
        </tr>`;
      }).join('');

      const nameArrow=sortState.by==='name'?(sortState.dir==='asc'?' ‚ñ≤':' ‚ñº'):''; 
      const amountArrow=sortState.by==='amount'?(sortState.dir==='asc'?' ‚ñ≤':' ‚ñº'):'';
      const nameAria=sortState.by==='name'?(sortState.dir==='asc'?'ascending':'descending'):'none';
      const amountAria=sortState.by==='amount'?(sortState.dir==='asc'?'ascending':'descending'):'none';

      tbl.innerHTML=`<thead>
        <tr>
          <th class="sortable" data-sort="name" aria-sort="${nameAria}" scope="col">Ng∆∞·ªùi${nameArrow}</th>
          <th class="sortable" data-sort="amount" aria-sort="${amountAria}" scope="col">S·ªë ti·ªÅn ph·∫£i tr·∫£${amountArrow}</th>
        </tr></thead>
        <tbody>${body}</tbody>
        <tfoot><tr><td>T·ªïng c√°c m·ª•c</td><td>${fmt.format(grand)} ƒë</td></tr></tfoot>`;
    }
    function toggleSort(by){ if(sortState.by===by) sortState.dir=(sortState.dir==='asc'?'desc':'asc'); else{ sortState.by=by; sortState.dir='asc'; } renderSummary(); }
    function copySummary(){
      const {totals,grand}=computeSummary();
      const lines=['T·ªïng k·∫øt chia ti·ªÅn:',
        ...Object.entries(totals).map(([n,v])=>{
          const eff=getEffectiveAmount(n,v);
          const status=state.paid[n]?' (ƒë√£ tr·∫£)':(state.waived[n]?' (ƒë√£ xo√° n·ª£)':'');
          return `- ${n}: ${fmt.format(eff)} ƒë${status}${eff!==v?` [g·ªëc ${fmt.format(v)}]`:''}`;
        }),
        `T·ªïng c√°c m·ª•c: ${fmt.format(grand)} ƒë`];
      navigator.clipboard.writeText(lines.join('\n')).then(()=>toast('ƒê√£ sao ch√©p'),()=>toast('Kh√¥ng th·ªÉ sao ch√©p'));
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function downloadCSV(){
      const {totals,grand}=computeSummary();
      const rows=[['T√™n','S·ªë ti·ªÅn (VND)','Tr·∫°ng th√°i','G·ªëc (VND)']];
      for(const [n,base] of Object.entries(totals)){
        const eff=getEffectiveAmount(n,base);
        const status= state.paid[n]?'ƒê√£ tr·∫£':(state.waived[n]?'ƒê√£ xo√° n·ª£':'');
        rows.push([n, Math.round(eff), status, Math.round(base)]);
      }
      rows.push(['T·ªïng', Math.round(grand), '', '']);
      const csv=rows.map(r=>r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n');
      const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      const d=new Date(); a.download=`tong-ket-chia-tien_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    // ====== VIETQR (banks + QR) ======
    const API_BANKS='https://api.vietqr.io/v2/banks'; const LS_BANKS='vietqr_banks_v2'; const LS_AT='vietqr_banks_cached_at'; const ONE_DAY=24*60*60*1000;
    async function loadBanks(force=false){
      const stat=$('#bankStat'); try{
        if(!force){ const cached=localStorage.getItem(LS_BANKS); const at=Number(localStorage.getItem(LS_AT)||0);
          if(cached && Date.now()-at<ONE_DAY){ state.banksCache=JSON.parse(cached); renderBankSelect(); if(stat) stat.textContent=`ƒêang d√πng cache (${state.banksCache.length} NH)`; return; } }
        const res=await fetch(API_BANKS,{headers:{'Accept':'application/json'}}); if(!res.ok) throw new Error('HTTP '+res.status);
        const json=await res.json(); if(json&&Array.isArray(json.data)){ state.banksCache=json.data; localStorage.setItem(LS_BANKS,JSON.stringify(state.banksCache)); localStorage.setItem(LS_AT,String(Date.now())); renderBankSelect(); if(stat) stat.textContent=`ƒê√£ t·∫£i (${state.banksCache.length} NH)`; }
        else throw new Error('Sai ƒë·ªãnh d·∫°ng');
      }catch(e){ console.error(e); if(stat) stat.textContent='L·ªói t·∫£i ng√¢n h√†ng'; }
    }
    function renderBankSelect(){
      const sel=$('#bankSelect'); const opts=['<option value="">‚Äî Ch·ªçn ng√¢n h√†ng ‚Äî</option>'].concat(
        state.banksCache.map(b=>{
          const selected = (state.bank.bin && state.bank.bin==b.bin)?'selected':'';
          return `<option value="${b.bin}" data-code="${escAttr(b.code||'')}" data-short="${escAttr(b.shortName||'')}" data-name="${escAttr(b.name||'')}" ${selected}>${b.shortName||b.code||b.name} ‚Äî ${b.bin}</option>`;
        })
      );
      sel.innerHTML=opts.join('');
      // restore inputs
      $('#accNo').value = state.bank.accountNo||'';
      $('#accName').value = state.bank.accountName||'';
      $('#addInfo').value = state.bank.addInfo||'';
      // disable inputs if view-only
      sel.disabled=viewOnly; $('#accNo').disabled=viewOnly; $('#accName').disabled=viewOnly; $('#addInfo').disabled=viewOnly; $('#testQR').disabled=viewOnly;
    }
    function saveBankFromUI(){
      if(viewOnly) return;
      const opt=$('#bankSelect').selectedOptions[0];
      state.bank.bin = $('#bankSelect').value||'';
      state.bank.code = opt? opt.getAttribute('data-code') : '';
      state.bank.shortName = opt? opt.getAttribute('data-short') : '';
      state.bank.name = opt? opt.getAttribute('data-name') : '';
      state.bank.accountNo = $('#accNo').value.trim();
      state.bank.accountName = $('#accName').value.trim();
      state.bank.addInfo = $('#addInfo').value.trim();
      save();
    }
    function makeQuickLink(amount, payerName=''){
      const bankId = state.bank.bin || state.bank.code || state.bank.shortName;
      const accNo = (state.bank.accountNo||'').replace(/\s+/g,'');
      if(!bankId||!accNo){ throw new Error('Ch∆∞a ch·ªçn ng√¢n h√†ng/STK'); }
      let addInfo = (state.bank.addInfo || `CHI A ${payerName}` || '').normalize("NFKD").replace(/[^\w\s-]/g,'');
      if(addInfo.length>50) addInfo = addInfo.slice(0,50);
      const params = new URLSearchParams();
      if(amount>0) params.set('amount', Math.round(amount));
      if(addInfo) params.set('addInfo', addInfo);
      if(state.bank.accountName){ params.set('accountName', state.bank.accountName); }
      const template='compact2';
      const url=`https://img.vietqr.io/image/${encodeURIComponent(bankId)}-${encodeURIComponent(accNo)}-${template}.png${params.toString()?('?'+params.toString()):''}`;
      return url;
    }
    function openQR(amount, name){
      try{
        const url = makeQuickLink(amount, name);
        $('#qrTitle').textContent='QR thanh to√°n';
        $('#qrInfo').innerHTML = `Ng∆∞·ªùi tr·∫£: <b>${esc(name)}</b> ‚Ä¢ S·ªë ti·ªÅn: <b>${fmt.format(Math.round(amount))} ƒë</b>`;
        const wrap=$('#qrWrap'); wrap.innerHTML='';
        const img=new Image(); img.alt='VietQR'; img.style.maxWidth='100%'; img.style.height='auto'; img.src=url;
        wrap.appendChild(img);
        const a=$('#qrOpenLink'); a.href=url;
        $('#qrDialog').showModal();
      }catch(e){ toast(e.message || 'Thi·∫øu th√¥ng tin VietQR'); }
    }

    // ====== SHARE LINK (VIEW-ONLY) ======
    function toB64Url(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }
    function fromB64Url(s){
      s = s.replace(/-/g,'+').replace(/_/g,'/');
      const pad = s.length % 4 ? 4 - (s.length % 4) : 0;
      s = s + '='.repeat(pad);
      const json = decodeURIComponent(escape(atob(s)));
      return json;
    }
    function buildShareObject(){
      return {
        version:1,
        friends: state.friends,
        items: state.items,
        paid: state.paid,
        waived: state.waived,
        bank: state.bank
      };
    }
    function makeShareLink(){
      const base = location.origin + location.pathname;
      const payload = toB64Url(JSON.stringify(buildShareObject()));
      return `${base}#v=${payload}`;
    }
    function copyShareLink(){
      const link = makeShareLink();
      navigator.clipboard.writeText(link).then(()=>toast('ƒê√£ copy li√™n k·∫øt xem'),()=>{ prompt('Copy li√™n k·∫øt n√†y:', link); });
    }
    function adoptSharedToLocal(){
      // Ghi snapshot hi·ªán t·∫°i v√†o LocalStorage ƒë·ªÉ ch·ªânh s·ª≠a
      localStorage.setItem(storeKey, JSON.stringify(buildShareObject()));
      location.hash=''; viewOnly=false; fromShared=false;
      $('#viewBanner').style.display='none';
      save(); renderAll();
      toast('ƒê√£ l∆∞u b·∫£n n√†y v√†o tr√¨nh duy·ªát ‚Äì c√≥ th·ªÉ ch·ªânh s·ª≠a');
    }
    function enterViewMode(shared){
      // G√°n state t·ª´ snapshot, KH√îNG l∆∞u local
      state.friends = Array.isArray(shared.friends)?shared.friends:[];
      state.items   = Array.isArray(shared.items)?shared.items:[];
      state.paid    = shared.paid||{};
      state.waived  = shared.waived||{};
      state.bank    = Object.assign(state.bank, shared.bank||{});
      viewOnly=true; fromShared=true;
      $('#viewBanner').style.display='block';
      // Kho√° c√°c input
      $('#friendName').disabled=true; $('#addFriendBtn').disabled=true; $('#clearAllBtn').disabled=true;
      $('#itemName').disabled=true; $('#itemAmount').disabled=true; $('#addItemBtn').disabled=true;
      $('#selectAllBtn').disabled=true; $('#selectNoneBtn').disabled=true;
      renderAll();
    }

    // ====== UTILS ======
    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } return Math.abs(h); }
    function esc(s){ return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escAttr(s){ return esc(s).replace(/\n/g,' '); }
    function toast(msg){ const t=document.createElement('div'); t.textContent=msg;
      Object.assign(t.style,{position:'fixed',left:'50%',bottom:'22px',transform:'translateX(-50%)',background:'linear-gradient(90deg,var(--accent),var(--accent-2))',color:'#fff',padding:'10px 14px',borderRadius:'12px',boxShadow:'var(--shadow)',fontSize:'14px',zIndex:9999});
      document.body.appendChild(t); setTimeout(()=>{ t.style.transition='opacity .4s'; t.style.opacity='0'; setTimeout(()=>t.remove(),400); },1100);
    }

    function renderAll(){ renderFriends(); renderItems(); renderSummary(); renderBankSelect(); }

    // ====== EVENTS ======
    // Friends
    $('#addFriendBtn').addEventListener('click',()=>addFriend($('#friendName').value));
    $('#friendName').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addFriend($('#friendName').value);} });
    $('#clearAllBtn').addEventListener('click',()=>{
      if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; }
      if(confirm('Xo√° to√†n b·ªô b·∫°n b√®, m·ª•c v√† t·ªïng k·∫øt?')){ state.friends=[]; state.items=[]; state.paid={}; state.waived={}; save(); renderAll(); $('#friendName').focus(); }
    });
    $('#friends').addEventListener('click',e=>{ const x=e.target.closest('.x'); if(x){ removeFriend(x.getAttribute('data-name')); } });
    $('#friends').addEventListener('keydown',e=>{ const x=e.target.closest('.x'); if(x&&(e.key==='Enter'||e.key===' ')){ e.preventDefault(); removeFriend(x.getAttribute('data-name')); } });

    // Items
    $('#addItemBtn').addEventListener('click',addItem);
    $('#selectAllBtn').addEventListener('click',()=>setAllParticipants(true));
    $('#selectNoneBtn').addEventListener('click',()=>setAllParticipants(false));
    $('#items').addEventListener('click',e=>{
      const del=e.target.closest('[data-del]'); const edit=e.target.closest('[data-edit]');
      if(del) deleteItem(del.getAttribute('data-del')); if(edit) editItem(edit.getAttribute('data-edit'));
    });

    // Summary actions & sorting
    $('#summaryTable').addEventListener('click',e=>{
      const th=e.target.closest('.sortable'); if(th){ toggleSort(th.getAttribute('data-sort')); return; }
      const btnQr=e.target.closest('[data-qr]'); if(btnQr){
        const name=btnQr.getAttribute('data-qr'); const {totals}=computeSummary(); const base=totals[name]||0; const amount=getEffectiveAmount(name,base);
        if(amount<=0){ toast('S·ªë ti·ªÅn b·∫±ng 0'); return; } openQR(amount,name); return;
      }
      if(viewOnly) return;
      const btnPaid=e.target.closest('[data-paid]'); if(btnPaid){ const n=btnPaid.getAttribute('data-paid'); state.paid[n]=true; delete state.waived[n]; save(); renderSummary(); return; }
      const btnWaive=e.target.closest('[data-waive]'); if(btnWaive){ const n=btnWaive.getAttribute('data-waive'); state.waived[n]=true; delete state.paid[n]; save(); renderSummary(); return; }
      const btnUndo=e.target.closest('[data-undo]'); if(btnUndo){ const n=btnUndo.getAttribute('data-undo'); delete state.paid[n]; delete state.waived[n]; save(); renderSummary(); return; }
    });

    $('#copyBtn').addEventListener('click',copySummary);
    $('#csvBtn').addEventListener('click',downloadCSV);
    $('#shareBtn').addEventListener('click',copyShareLink);

    // Help
    $('#howtoLink').addEventListener('click',e=>{ e.preventDefault(); $('#howto').showModal(); });

    // VietQR form
    $('#bankSelect').addEventListener('change',()=>{ saveBankFromUI(); });
    $('#accNo').addEventListener('input',saveBankFromUI);
    $('#accName').addEventListener('input',saveBankFromUI);
    $('#addInfo').addEventListener('input',saveBankFromUI);
    $('#testQR').addEventListener('click',()=>{ if(viewOnly){ toast('ƒêang ·ªü ch·∫ø ƒë·ªô ch·ªâ xem'); return; } openQR(10000,'TEST') });

    // Banner buttons
    $('#shareCopyBtn2').addEventListener('click',()=>{ const link = location.href; navigator.clipboard.writeText(link).then(()=>toast('ƒê√£ copy li√™n k·∫øt'),()=>{ prompt('Copy li√™n k·∫øt n√†y:', link); }); });
    $('#adoptBtn').addEventListener('click',adoptSharedToLocal);

    // INIT
    // N·∫øu c√≥ #v=‚Ä¶ ‚Üí v√†o ch·∫ø ƒë·ªô xem
    const m = location.hash.match(/^#v=([A-Za-z0-9\-_]+)/);
    if(m){
      try{
        const obj = JSON.parse(fromB64Url(m[1]));
        enterViewMode(obj);
      }catch(err){
        console.error(err); toast('Li√™n k·∫øt kh√¥ng h·ª£p l·ªá'); load(); renderAll();
      }
    }else{
      load(); renderAll(); $('#friendName').focus();
    }
    loadBanks(); // t·∫£i danh s√°ch ng√¢n h√†ng t·ª´ VietQR
  })();
  </script>
</body>
</html>
